{
  "terraform": {
    "required_providers": {
      "aws": {
        "source": "hashicorp/aws",
        "version": "~> 5.0"
      }
    }
  },
  "provider": {
    "aws": {
      "region": "us-east-1"
    }
  },
  "resource": {
    "aws_s3_bucket": {
      "website": {
        "bucket": "my-static-website-bucket",
        "tags": {
          "Name": "Static Website Bucket",
          "Purpose": "CDN Origin"
        }
      }
    },
    "aws_s3_bucket_ownership_controls": {
      "website": {
        "bucket": "${aws_s3_bucket.website.id}",
        "rule": {
          "object_ownership": "BucketOwnerPreferred"
        }
      }
    },
    "aws_s3_bucket_public_access_block": {
      "website": {
        "bucket": "${aws_s3_bucket.website.id}",
        "block_public_acls": false,
        "block_public_policy": false,
        "ignore_public_acls": false,
        "restrict_public_buckets": false
      }
    },
    "aws_s3_bucket_policy": {
      "website": {
        "bucket": "${aws_s3_bucket.website.id}",
        "policy": "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"PublicReadGetObject\",\n      \"Effect\": \"Allow\",\n      \"Principal\": \"*\",\n      \"Action\": \"s3:GetObject\",\n      \"Resource\": \"${aws_s3_bucket.website.arn}/*\",\n      \"Condition\": {\n        \"StringEquals\": {\n          \"aws:UserAgent\": \"Amazon CloudFront\"\n        }\n      }\n    }\n  ]\n}"
      }
    },
    "aws_s3_bucket_versioning": {
      "website": {
        "bucket": "${aws_s3_bucket.website.id}",
        "versioning_configuration": {
          "status": "Enabled"
        }
      }
    },
    "aws_s3_bucket_server_side_encryption_configuration": {
      "website": {
        "bucket": "${aws_s3_bucket.website.id}",
        "rule": {
          "apply_server_side_encryption_by_default": {
            "sse_algorithm": "AES256"
          }
        }
      }
    },
    "aws_s3_bucket_logging": {
      "website": {
        "bucket": "${aws_s3_bucket.website.id}",
        "target_bucket": "${aws_s3_bucket.logs.id}",
        "target_prefix": "s3-access-logs/"
      }
    },
    "aws_s3_bucket": {
      "logs": {
        "bucket": "my-website-logs-bucket",
        "tags": {
          "Name": "Website Logs Bucket"
        }
      }
    },
    "aws_s3_bucket_lifecycle_configuration": {
      "logs": {
        "bucket": "${aws_s3_bucket.logs.id}",
        "rule": {
          "id": "log-expiration",
          "status": "Enabled",
          "expiration": {
            "days": 90
          }
        }
      }
    },
    "aws_cloudfront_origin_access_identity": {
      "website": {
        "comment": "OAI for static website"
      }
    },
    "aws_cloudfront_distribution": {
      "website": {
        "enabled": true,
        "is_ipv6_enabled": true,
        "comment": "Static website CDN",
        "default_root_object": "index.html",
        "aliases": ["www.example.com", "example.com"],
        "origin": {
          "domain_name": "${aws_s3_bucket.website.bucket_regional_domain_name}",
          "origin_id": "S3-Website",
          "s3_origin_config": {
            "origin_access_identity": "${aws_cloudfront_origin_access_identity.website.cloudfront_access_identity_path}"
          }
        },
        "default_cache_behavior": {
          "allowed_methods": ["GET", "HEAD", "OPTIONS"],
          "cached_methods": ["GET", "HEAD"],
          "target_origin_id": "S3-Website",
          "forwarded_values": {
            "query_string": false,
            "cookies": {
              "forward": "none"
            },
            "headers": ["Origin", "Access-Control-Request-Headers", "Access-Control-Request-Method"]
          },
          "viewer_protocol_policy": "redirect-to-https",
          "min_ttl": 0,
          "default_ttl": 3600,
          "max_ttl": 86400,
          "compress": true
        },
        "ordered_cache_behavior": [
          {
            "path_pattern": "/static/*",
            "allowed_methods": ["GET", "HEAD"],
            "cached_methods": ["GET", "HEAD"],
            "target_origin_id": "S3-Website",
            "forwarded_values": {
              "query_string": false,
              "cookies": {
                "forward": "none"
              }
            },
            "viewer_protocol_policy": "redirect-to-https",
            "min_ttl": 0,
            "default_ttl": 86400,
            "max_ttl": 31536000,
            "compress": true
          }
        ],
        "price_class": "PriceClass_100",
        "restrictions": {
          "geo_restriction": {
            "restriction_type": "none"
          }
        },
        "viewer_certificate": {
          "acm_certificate_arn": "${aws_acm_certificate.website.arn}",
          "ssl_support_method": "sni-only",
          "minimum_protocol_version": "TLSv1.2_2021"
        },
        "logging_config": {
          "include_cookies": false,
          "bucket": "${aws_s3_bucket.logs.bucket_domain_name}",
          "prefix": "cloudfront-logs/"
        },
        "custom_error_response": [
          {
            "error_code": 403,
            "response_code": 200,
            "response_page_path": "/index.html",
            "error_caching_min_ttl": 10
          },
          {
            "error_code": 404,
            "response_code": 200,
            "response_page_path": "/index.html",
            "error_caching_min_ttl": 10
          }
        ],
        "tags": {
          "Name": "website-cdn",
          "Environment": "production"
        }
      }
    },
    "aws_acm_certificate": {
      "website": {
        "domain_name": "example.com",
        "subject_alternative_names": ["*.example.com"],
        "validation_method": "DNS",
        "lifecycle": {
          "create_before_destroy": true
        },
        "tags": {
          "Name": "website-certificate"
        }
      }
    },
    "aws_route53_zone": {
      "main": {
        "name": "example.com"
      }
    },
    "aws_route53_record": {
      "cert_validation": {
        "for_each": "${{\n  for dvo in aws_acm_certificate.website.domain_validation_options : dvo.domain_name => {\n    name   = dvo.resource_record_name\n    record = dvo.resource_record_value\n    type   = dvo.resource_record_type\n  }\n}}",
        "allow_overwrite": true,
        "name": "${each.value.name}",
        "records": ["${each.value.record}"],
        "ttl": 60,
        "type": "${each.value.type}",
        "zone_id": "${aws_route53_zone.main.zone_id}"
      },
      "www": {
        "zone_id": "${aws_route53_zone.main.zone_id}",
        "name": "www.example.com",
        "type": "A",
        "alias": {
          "name": "${aws_cloudfront_distribution.website.domain_name}",
          "zone_id": "${aws_cloudfront_distribution.website.hosted_zone_id}",
          "evaluate_target_health": false
        }
      },
      "root": {
        "zone_id": "${aws_route53_zone.main.zone_id}",
        "name": "example.com",
        "type": "A",
        "alias": {
          "name": "${aws_cloudfront_distribution.website.domain_name}",
          "zone_id": "${aws_cloudfront_distribution.website.hosted_zone_id}",
          "evaluate_target_health": false
        }
      }
    },
    "aws_wafv2_web_acl": {
      "cloudfront": {
        "name": "cloudfront-waf",
        "scope": "CLOUDFRONT",
        "default_action": {
          "allow": {}
        },
        "rule": [
          {
            "name": "rate-limit-rule",
            "priority": 1,
            "action": {
              "block": {}
            },
            "statement": {
              "rate_based_statement": {
                "limit": 2000,
                "aggregate_key_type": "IP"
              }
            },
            "visibility_config": {
              "cloudwatch_metrics_enabled": true,
              "metric_name": "RateLimitRule",
              "sampled_requests_enabled": true
            }
          },
          {
            "name": "aws-managed-rules",
            "priority": 2,
            "override_action": {
              "none": {}
            },
            "statement": {
              "managed_rule_group_statement": {
                "vendor_name": "AWS",
                "name": "AWSManagedRulesCommonRuleSet"
              }
            },
            "visibility_config": {
              "cloudwatch_metrics_enabled": true,
              "metric_name": "AWSManagedRules",
              "sampled_requests_enabled": true
            }
          }
        ],
        "visibility_config": {
          "cloudwatch_metrics_enabled": true,
          "metric_name": "CloudFrontWAF",
          "sampled_requests_enabled": true
        }
      }
    }
  }
}
