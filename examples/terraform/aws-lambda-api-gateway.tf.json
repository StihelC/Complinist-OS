{
  "terraform": {
    "required_providers": {
      "aws": {
        "source": "hashicorp/aws",
        "version": "~> 5.0"
      }
    }
  },
  "provider": {
    "aws": {
      "region": "us-west-2"
    }
  },
  "resource": {
    "aws_iam_role": {
      "lambda": {
        "name": "lambda-execution-role",
        "assume_role_policy": "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\"\n      },\n      \"Effect\": \"Allow\"\n    }\n  ]\n}"
      }
    },
    "aws_iam_role_policy_attachment": {
      "lambda_basic": {
        "role": "${aws_iam_role.lambda.name}",
        "policy_arn": "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
      },
      "lambda_vpc": {
        "role": "${aws_iam_role.lambda.name}",
        "policy_arn": "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
      }
    },
    "aws_vpc": {
      "main": {
        "cidr_block": "10.0.0.0/16",
        "enable_dns_hostnames": true,
        "enable_dns_support": true,
        "tags": {
          "Name": "lambda-vpc"
        }
      }
    },
    "aws_subnet": {
      "private_1": {
        "vpc_id": "${aws_vpc.main.id}",
        "cidr_block": "10.0.1.0/24",
        "availability_zone": "us-west-2a",
        "tags": {
          "Name": "lambda-private-subnet-1"
        }
      },
      "private_2": {
        "vpc_id": "${aws_vpc.main.id}",
        "cidr_block": "10.0.2.0/24",
        "availability_zone": "us-west-2b",
        "tags": {
          "Name": "lambda-private-subnet-2"
        }
      }
    },
    "aws_security_group": {
      "lambda": {
        "name": "lambda-security-group",
        "description": "Security group for Lambda functions",
        "vpc_id": "${aws_vpc.main.id}",
        "egress": [
          {
            "from_port": 0,
            "to_port": 0,
            "protocol": "-1",
            "cidr_blocks": ["0.0.0.0/0"]
          }
        ],
        "tags": {
          "Name": "lambda-sg"
        }
      }
    },
    "aws_dynamodb_table": {
      "data": {
        "name": "application-data",
        "billing_mode": "PAY_PER_REQUEST",
        "hash_key": "id",
        "attribute": [
          {
            "name": "id",
            "type": "S"
          },
          {
            "name": "user_id",
            "type": "S"
          },
          {
            "name": "created_at",
            "type": "N"
          }
        ],
        "global_secondary_index": [
          {
            "name": "UserIndex",
            "hash_key": "user_id",
            "range_key": "created_at",
            "projection_type": "ALL"
          }
        ],
        "point_in_time_recovery": {
          "enabled": true
        },
        "server_side_encryption": {
          "enabled": true
        },
        "tags": {
          "Name": "application-data"
        }
      }
    },
    "aws_lambda_function": {
      "api_handler": {
        "filename": "lambda_function.zip",
        "function_name": "api-handler",
        "role": "${aws_iam_role.lambda.arn}",
        "handler": "index.handler",
        "runtime": "nodejs18.x",
        "timeout": 30,
        "memory_size": 512,
        "environment": {
          "variables": {
            "DYNAMODB_TABLE": "${aws_dynamodb_table.data.name}",
            "REGION": "us-west-2"
          }
        },
        "vpc_config": {
          "subnet_ids": [
            "${aws_subnet.private_1.id}",
            "${aws_subnet.private_2.id}"
          ],
          "security_group_ids": ["${aws_security_group.lambda.id}"]
        },
        "tags": {
          "Name": "api-handler"
        }
      },
      "auth_handler": {
        "filename": "auth_function.zip",
        "function_name": "auth-handler",
        "role": "${aws_iam_role.lambda.arn}",
        "handler": "auth.handler",
        "runtime": "nodejs18.x",
        "timeout": 10,
        "memory_size": 256,
        "environment": {
          "variables": {
            "JWT_SECRET": "changeme-secret-key"
          }
        },
        "tags": {
          "Name": "auth-handler"
        }
      }
    },
    "aws_cloudwatch_log_group": {
      "api_handler": {
        "name": "/aws/lambda/${aws_lambda_function.api_handler.function_name}",
        "retention_in_days": 14
      },
      "auth_handler": {
        "name": "/aws/lambda/${aws_lambda_function.auth_handler.function_name}",
        "retention_in_days": 14
      }
    },
    "aws_apigatewayv2_api": {
      "main": {
        "name": "main-api",
        "protocol_type": "HTTP",
        "cors_configuration": {
          "allow_origins": ["*"],
          "allow_methods": ["GET", "POST", "PUT", "DELETE"],
          "allow_headers": ["content-type", "authorization"],
          "max_age": 300
        }
      }
    },
    "aws_apigatewayv2_stage": {
      "prod": {
        "api_id": "${aws_apigatewayv2_api.main.id}",
        "name": "$default",
        "auto_deploy": true,
        "access_log_settings": {
          "destination_arn": "${aws_cloudwatch_log_group.api_gw.arn}",
          "format": "$context.requestId $context.error.message $context.error.messageString"
        }
      }
    },
    "aws_cloudwatch_log_group": {
      "api_gw": {
        "name": "/aws/api-gateway/${aws_apigatewayv2_api.main.name}",
        "retention_in_days": 14
      }
    },
    "aws_apigatewayv2_integration": {
      "api_handler": {
        "api_id": "${aws_apigatewayv2_api.main.id}",
        "integration_type": "AWS_PROXY",
        "integration_uri": "${aws_lambda_function.api_handler.invoke_arn}",
        "integration_method": "POST",
        "payload_format_version": "2.0"
      },
      "auth_handler": {
        "api_id": "${aws_apigatewayv2_api.main.id}",
        "integration_type": "AWS_PROXY",
        "integration_uri": "${aws_lambda_function.auth_handler.invoke_arn}",
        "integration_method": "POST",
        "payload_format_version": "2.0"
      }
    },
    "aws_apigatewayv2_route": {
      "get_items": {
        "api_id": "${aws_apigatewayv2_api.main.id}",
        "route_key": "GET /items",
        "target": "integrations/${aws_apigatewayv2_integration.api_handler.id}"
      },
      "post_items": {
        "api_id": "${aws_apigatewayv2_api.main.id}",
        "route_key": "POST /items",
        "target": "integrations/${aws_apigatewayv2_integration.api_handler.id}"
      },
      "auth": {
        "api_id": "${aws_apigatewayv2_api.main.id}",
        "route_key": "POST /auth",
        "target": "integrations/${aws_apigatewayv2_integration.auth_handler.id}"
      }
    },
    "aws_lambda_permission": {
      "api_handler": {
        "statement_id": "AllowExecutionFromAPIGateway",
        "action": "lambda:InvokeFunction",
        "function_name": "${aws_lambda_function.api_handler.function_name}",
        "principal": "apigateway.amazonaws.com",
        "source_arn": "${aws_apigatewayv2_api.main.execution_arn}/*/*"
      },
      "auth_handler": {
        "statement_id": "AllowExecutionFromAPIGateway",
        "action": "lambda:InvokeFunction",
        "function_name": "${aws_lambda_function.auth_handler.function_name}",
        "principal": "apigateway.amazonaws.com",
        "source_arn": "${aws_apigatewayv2_api.main.execution_arn}/*/*"
      }
    },
    "aws_iam_policy": {
      "lambda_dynamodb": {
        "name": "lambda-dynamodb-policy",
        "policy": "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"dynamodb:GetItem\",\n        \"dynamodb:PutItem\",\n        \"dynamodb:UpdateItem\",\n        \"dynamodb:DeleteItem\",\n        \"dynamodb:Query\",\n        \"dynamodb:Scan\"\n      ],\n      \"Resource\": \"${aws_dynamodb_table.data.arn}\"\n    },\n    {\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"dynamodb:Query\"\n      ],\n      \"Resource\": \"${aws_dynamodb_table.data.arn}/index/*\"\n    }\n  ]\n}"
      }
    },
    "aws_iam_role_policy_attachment": {
      "lambda_dynamodb": {
        "role": "${aws_iam_role.lambda.name}",
        "policy_arn": "${aws_iam_policy.lambda_dynamodb.arn}"
      }
    }
  }
}
