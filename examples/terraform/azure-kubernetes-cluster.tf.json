{
  "terraform": {
    "required_providers": {
      "azurerm": {
        "source": "hashicorp/azurerm",
        "version": "~> 3.0"
      }
    }
  },
  "provider": {
    "azurerm": {
      "features": {}
    }
  },
  "resource": {
    "azurerm_resource_group": {
      "main": {
        "name": "aks-resources",
        "location": "East US"
      }
    },
    "azurerm_virtual_network": {
      "main": {
        "name": "aks-vnet",
        "address_space": ["10.1.0.0/16"],
        "location": "${azurerm_resource_group.main.location}",
        "resource_group_name": "${azurerm_resource_group.main.name}",
        "tags": {
          "Environment": "production"
        }
      }
    },
    "azurerm_subnet": {
      "aks": {
        "name": "aks-subnet",
        "resource_group_name": "${azurerm_resource_group.main.name}",
        "virtual_network_name": "${azurerm_virtual_network.main.name}",
        "address_prefixes": ["10.1.0.0/20"]
      },
      "appgw": {
        "name": "appgw-subnet",
        "resource_group_name": "${azurerm_resource_group.main.name}",
        "virtual_network_name": "${azurerm_virtual_network.main.name}",
        "address_prefixes": ["10.1.16.0/24"]
      }
    },
    "azurerm_network_security_group": {
      "aks": {
        "name": "aks-nsg",
        "location": "${azurerm_resource_group.main.location}",
        "resource_group_name": "${azurerm_resource_group.main.name}",
        "security_rule": [
          {
            "name": "allow-https",
            "priority": 100,
            "direction": "Inbound",
            "access": "Allow",
            "protocol": "Tcp",
            "source_port_range": "*",
            "destination_port_range": "443",
            "source_address_prefix": "*",
            "destination_address_prefix": "*"
          },
          {
            "name": "allow-http",
            "priority": 110,
            "direction": "Inbound",
            "access": "Allow",
            "protocol": "Tcp",
            "source_port_range": "*",
            "destination_port_range": "80",
            "source_address_prefix": "*",
            "destination_address_prefix": "*"
          }
        ]
      }
    },
    "azurerm_kubernetes_cluster": {
      "main": {
        "name": "production-aks",
        "location": "${azurerm_resource_group.main.location}",
        "resource_group_name": "${azurerm_resource_group.main.name}",
        "dns_prefix": "prodaks",
        "kubernetes_version": "1.27.7",
        "default_node_pool": {
          "name": "default",
          "node_count": 3,
          "vm_size": "Standard_D4s_v3",
          "vnet_subnet_id": "${azurerm_subnet.aks.id}",
          "enable_auto_scaling": true,
          "min_count": 2,
          "max_count": 5,
          "max_pods": 110,
          "os_disk_size_gb": 128,
          "type": "VirtualMachineScaleSets",
          "tags": {
            "NodePool": "default"
          }
        },
        "identity": {
          "type": "SystemAssigned"
        },
        "network_profile": {
          "network_plugin": "azure",
          "network_policy": "azure",
          "service_cidr": "10.2.0.0/16",
          "dns_service_ip": "10.2.0.10",
          "load_balancer_sku": "standard"
        },
        "addon_profile": {
          "oms_agent": {
            "enabled": true,
            "log_analytics_workspace_id": "${azurerm_log_analytics_workspace.main.id}"
          },
          "azure_policy": {
            "enabled": true
          }
        },
        "tags": {
          "Environment": "production",
          "ManagedBy": "Terraform"
        }
      }
    },
    "azurerm_kubernetes_cluster_node_pool": {
      "workload": {
        "name": "workload",
        "kubernetes_cluster_id": "${azurerm_kubernetes_cluster.main.id}",
        "vm_size": "Standard_D8s_v3",
        "node_count": 2,
        "enable_auto_scaling": true,
        "min_count": 1,
        "max_count": 4,
        "vnet_subnet_id": "${azurerm_subnet.aks.id}",
        "tags": {
          "NodePool": "workload"
        }
      }
    },
    "azurerm_log_analytics_workspace": {
      "main": {
        "name": "aks-logs",
        "location": "${azurerm_resource_group.main.location}",
        "resource_group_name": "${azurerm_resource_group.main.name}",
        "sku": "PerGB2018",
        "retention_in_days": 30
      }
    },
    "azurerm_container_registry": {
      "main": {
        "name": "prodacr",
        "resource_group_name": "${azurerm_resource_group.main.name}",
        "location": "${azurerm_resource_group.main.location}",
        "sku": "Premium",
        "admin_enabled": false,
        "georeplications": [
          {
            "location": "West US",
            "zone_redundancy_enabled": true
          }
        ]
      }
    },
    "azurerm_public_ip": {
      "appgw": {
        "name": "appgw-pip",
        "resource_group_name": "${azurerm_resource_group.main.name}",
        "location": "${azurerm_resource_group.main.location}",
        "allocation_method": "Static",
        "sku": "Standard"
      }
    },
    "azurerm_application_gateway": {
      "main": {
        "name": "aks-appgw",
        "resource_group_name": "${azurerm_resource_group.main.name}",
        "location": "${azurerm_resource_group.main.location}",
        "sku": {
          "name": "WAF_v2",
          "tier": "WAF_v2",
          "capacity": 2
        },
        "gateway_ip_configuration": {
          "name": "gateway-ip-config",
          "subnet_id": "${azurerm_subnet.appgw.id}"
        },
        "frontend_port": {
          "name": "frontend-port",
          "port": 80
        },
        "frontend_ip_configuration": {
          "name": "frontend-ip-config",
          "public_ip_address_id": "${azurerm_public_ip.appgw.id}"
        },
        "backend_address_pool": {
          "name": "backend-pool"
        },
        "backend_http_settings": {
          "name": "backend-http-settings",
          "cookie_based_affinity": "Disabled",
          "port": 80,
          "protocol": "Http",
          "request_timeout": 60
        },
        "http_listener": {
          "name": "http-listener",
          "frontend_ip_configuration_name": "frontend-ip-config",
          "frontend_port_name": "frontend-port",
          "protocol": "Http"
        },
        "request_routing_rule": {
          "name": "routing-rule",
          "rule_type": "Basic",
          "http_listener_name": "http-listener",
          "backend_address_pool_name": "backend-pool",
          "backend_http_settings_name": "backend-http-settings",
          "priority": 100
        },
        "waf_configuration": {
          "enabled": true,
          "firewall_mode": "Prevention",
          "rule_set_type": "OWASP",
          "rule_set_version": "3.2"
        }
      }
    }
  }
}
