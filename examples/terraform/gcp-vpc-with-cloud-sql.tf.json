{
  "terraform": {
    "required_providers": {
      "google": {
        "source": "hashicorp/google",
        "version": "~> 5.0"
      }
    }
  },
  "provider": {
    "google": {
      "project": "my-gcp-project",
      "region": "us-central1"
    }
  },
  "resource": {
    "google_compute_network": {
      "main": {
        "name": "main-vpc",
        "auto_create_subnetworks": false,
        "routing_mode": "REGIONAL"
      }
    },
    "google_compute_subnetwork": {
      "web": {
        "name": "web-subnet",
        "ip_cidr_range": "10.0.1.0/24",
        "region": "us-central1",
        "network": "${google_compute_network.main.id}",
        "private_ip_google_access": true
      },
      "app": {
        "name": "app-subnet",
        "ip_cidr_range": "10.0.2.0/24",
        "region": "us-central1",
        "network": "${google_compute_network.main.id}",
        "private_ip_google_access": true
      },
      "data": {
        "name": "data-subnet",
        "ip_cidr_range": "10.0.3.0/24",
        "region": "us-central1",
        "network": "${google_compute_network.main.id}",
        "private_ip_google_access": true
      }
    },
    "google_compute_firewall": {
      "allow_internal": {
        "name": "allow-internal",
        "network": "${google_compute_network.main.name}",
        "allow": [
          {
            "protocol": "icmp"
          },
          {
            "protocol": "tcp",
            "ports": ["0-65535"]
          },
          {
            "protocol": "udp",
            "ports": ["0-65535"]
          }
        ],
        "source_ranges": ["10.0.0.0/16"]
      },
      "allow_http_https": {
        "name": "allow-http-https",
        "network": "${google_compute_network.main.name}",
        "allow": [
          {
            "protocol": "tcp",
            "ports": ["80", "443"]
          }
        ],
        "source_ranges": ["0.0.0.0/0"],
        "target_tags": ["web-server"]
      },
      "allow_ssh_iap": {
        "name": "allow-ssh-iap",
        "network": "${google_compute_network.main.name}",
        "allow": [
          {
            "protocol": "tcp",
            "ports": ["22"]
          }
        ],
        "source_ranges": ["35.235.240.0/20"]
      }
    },
    "google_compute_router": {
      "main": {
        "name": "main-router",
        "region": "us-central1",
        "network": "${google_compute_network.main.id}",
        "bgp": {
          "asn": 64514
        }
      }
    },
    "google_compute_router_nat": {
      "main": {
        "name": "main-nat",
        "router": "${google_compute_router.main.name}",
        "region": "us-central1",
        "nat_ip_allocate_option": "AUTO_ONLY",
        "source_subnetwork_ip_ranges_to_nat": "ALL_SUBNETWORKS_ALL_IP_RANGES"
      }
    },
    "google_compute_global_address": {
      "private_ip_address": {
        "name": "private-ip-address",
        "purpose": "VPC_PEERING",
        "address_type": "INTERNAL",
        "prefix_length": 16,
        "network": "${google_compute_network.main.id}"
      }
    },
    "google_service_networking_connection": {
      "private_vpc_connection": {
        "network": "${google_compute_network.main.id}",
        "service": "servicenetworking.googleapis.com",
        "reserved_peering_ranges": ["${google_compute_global_address.private_ip_address.name}"]
      }
    },
    "google_sql_database_instance": {
      "main": {
        "name": "main-database-instance",
        "region": "us-central1",
        "database_version": "POSTGRES_15",
        "settings": {
          "tier": "db-custom-4-16384",
          "availability_type": "REGIONAL",
          "disk_type": "PD_SSD",
          "disk_size": 100,
          "backup_configuration": {
            "enabled": true,
            "start_time": "03:00",
            "point_in_time_recovery_enabled": true,
            "transaction_log_retention_days": 7,
            "backup_retention_settings": {
              "retained_backups": 30
            }
          },
          "ip_configuration": {
            "ipv4_enabled": false,
            "private_network": "${google_compute_network.main.id}",
            "require_ssl": true
          },
          "database_flags": [
            {
              "name": "log_checkpoints",
              "value": "on"
            },
            {
              "name": "log_connections",
              "value": "on"
            }
          ],
          "insights_config": {
            "query_insights_enabled": true,
            "query_plans_per_minute": 5
          }
        },
        "deletion_protection": true,
        "depends_on": ["google_service_networking_connection.private_vpc_connection"]
      }
    },
    "google_sql_database": {
      "main": {
        "name": "application_db",
        "instance": "${google_sql_database_instance.main.name}"
      }
    },
    "google_sql_user": {
      "main": {
        "name": "app_user",
        "instance": "${google_sql_database_instance.main.name}",
        "password": "changeme-secure-password"
      }
    },
    "google_compute_instance_template": {
      "web": {
        "name": "web-instance-template",
        "machine_type": "e2-medium",
        "tags": ["web-server"],
        "disk": {
          "source_image": "debian-cloud/debian-11",
          "auto_delete": true,
          "boot": true,
          "disk_size_gb": 20
        },
        "network_interface": {
          "network": "${google_compute_network.main.id}",
          "subnetwork": "${google_compute_subnetwork.web.id}"
        },
        "service_account": {
          "scopes": ["cloud-platform"]
        },
        "metadata_startup_script": "#!/bin/bash\napt-get update\napt-get install -y nginx\nsystemctl start nginx"
      }
    },
    "google_compute_health_check": {
      "web": {
        "name": "web-health-check",
        "check_interval_sec": 5,
        "timeout_sec": 5,
        "healthy_threshold": 2,
        "unhealthy_threshold": 2,
        "http_health_check": {
          "port": 80,
          "request_path": "/"
        }
      }
    },
    "google_compute_region_instance_group_manager": {
      "web": {
        "name": "web-igm",
        "region": "us-central1",
        "version": {
          "instance_template": "${google_compute_instance_template.web.id}"
        },
        "base_instance_name": "web",
        "target_size": 2,
        "named_port": {
          "name": "http",
          "port": 80
        },
        "auto_healing_policies": {
          "health_check": "${google_compute_health_check.web.id}",
          "initial_delay_sec": 300
        }
      }
    },
    "google_compute_region_autoscaler": {
      "web": {
        "name": "web-autoscaler",
        "region": "us-central1",
        "target": "${google_compute_region_instance_group_manager.web.id}",
        "autoscaling_policy": {
          "max_replicas": 5,
          "min_replicas": 2,
          "cooldown_period": 60,
          "cpu_utilization": {
            "target": 0.7
          }
        }
      }
    },
    "google_compute_global_address": {
      "lb": {
        "name": "lb-ipv4-address",
        "ip_version": "IPV4"
      }
    },
    "google_compute_backend_service": {
      "web": {
        "name": "web-backend-service",
        "protocol": "HTTP",
        "timeout_sec": 10,
        "health_checks": ["${google_compute_health_check.web.id}"],
        "backend": {
          "group": "${google_compute_region_instance_group_manager.web.instance_group}",
          "balancing_mode": "UTILIZATION",
          "capacity_scaler": 1.0
        }
      }
    },
    "google_compute_url_map": {
      "web": {
        "name": "web-url-map",
        "default_service": "${google_compute_backend_service.web.id}"
      }
    },
    "google_compute_target_http_proxy": {
      "web": {
        "name": "web-http-proxy",
        "url_map": "${google_compute_url_map.web.id}"
      }
    },
    "google_compute_global_forwarding_rule": {
      "web": {
        "name": "web-forwarding-rule",
        "ip_protocol": "TCP",
        "load_balancing_scheme": "EXTERNAL",
        "port_range": "80",
        "target": "${google_compute_target_http_proxy.web.id}",
        "ip_address": "${google_compute_global_address.lb.id}"
      }
    }
  }
}
