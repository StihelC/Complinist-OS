{
  "terraform": {
    "required_providers": {
      "aws": {
        "source": "hashicorp/aws",
        "version": "~> 5.0"
      }
    }
  },
  "provider": {
    "aws": {
      "region": "us-east-1"
    }
  },
  "resource": {
    "aws_vpc": {
      "main": {
        "cidr_block": "10.0.0.0/16",
        "enable_dns_hostnames": true,
        "enable_dns_support": true,
        "tags": {
          "Name": "three-tier-vpc",
          "Environment": "production"
        }
      }
    },
    "aws_subnet": {
      "public_1": {
        "vpc_id": "${aws_vpc.main.id}",
        "cidr_block": "10.0.1.0/24",
        "availability_zone": "us-east-1a",
        "map_public_ip_on_launch": true,
        "tags": {
          "Name": "public-subnet-1",
          "Tier": "public"
        }
      },
      "public_2": {
        "vpc_id": "${aws_vpc.main.id}",
        "cidr_block": "10.0.2.0/24",
        "availability_zone": "us-east-1b",
        "map_public_ip_on_launch": true,
        "tags": {
          "Name": "public-subnet-2",
          "Tier": "public"
        }
      },
      "private_app_1": {
        "vpc_id": "${aws_vpc.main.id}",
        "cidr_block": "10.0.10.0/24",
        "availability_zone": "us-east-1a",
        "tags": {
          "Name": "private-app-subnet-1",
          "Tier": "application"
        }
      },
      "private_app_2": {
        "vpc_id": "${aws_vpc.main.id}",
        "cidr_block": "10.0.11.0/24",
        "availability_zone": "us-east-1b",
        "tags": {
          "Name": "private-app-subnet-2",
          "Tier": "application"
        }
      },
      "private_db_1": {
        "vpc_id": "${aws_vpc.main.id}",
        "cidr_block": "10.0.20.0/24",
        "availability_zone": "us-east-1a",
        "tags": {
          "Name": "private-db-subnet-1",
          "Tier": "database"
        }
      },
      "private_db_2": {
        "vpc_id": "${aws_vpc.main.id}",
        "cidr_block": "10.0.21.0/24",
        "availability_zone": "us-east-1b",
        "tags": {
          "Name": "private-db-subnet-2",
          "Tier": "database"
        }
      }
    },
    "aws_internet_gateway": {
      "main": {
        "vpc_id": "${aws_vpc.main.id}",
        "tags": {
          "Name": "main-igw"
        }
      }
    },
    "aws_eip": {
      "nat_1": {
        "domain": "vpc",
        "tags": {
          "Name": "nat-eip-1"
        }
      },
      "nat_2": {
        "domain": "vpc",
        "tags": {
          "Name": "nat-eip-2"
        }
      }
    },
    "aws_nat_gateway": {
      "nat_1": {
        "allocation_id": "${aws_eip.nat_1.id}",
        "subnet_id": "${aws_subnet.public_1.id}",
        "tags": {
          "Name": "nat-gateway-1"
        }
      },
      "nat_2": {
        "allocation_id": "${aws_eip.nat_2.id}",
        "subnet_id": "${aws_subnet.public_2.id}",
        "tags": {
          "Name": "nat-gateway-2"
        }
      }
    },
    "aws_security_group": {
      "alb": {
        "name": "alb-security-group",
        "description": "Security group for Application Load Balancer",
        "vpc_id": "${aws_vpc.main.id}",
        "ingress": [
          {
            "from_port": 443,
            "to_port": 443,
            "protocol": "tcp",
            "cidr_blocks": ["0.0.0.0/0"],
            "description": "HTTPS from internet"
          },
          {
            "from_port": 80,
            "to_port": 80,
            "protocol": "tcp",
            "cidr_blocks": ["0.0.0.0/0"],
            "description": "HTTP from internet"
          }
        ],
        "egress": [
          {
            "from_port": 0,
            "to_port": 0,
            "protocol": "-1",
            "cidr_blocks": ["0.0.0.0/0"]
          }
        ],
        "tags": {
          "Name": "alb-sg"
        }
      },
      "web": {
        "name": "web-security-group",
        "description": "Security group for web servers",
        "vpc_id": "${aws_vpc.main.id}",
        "ingress": [
          {
            "from_port": 80,
            "to_port": 80,
            "protocol": "tcp",
            "security_groups": ["${aws_security_group.alb.id}"],
            "description": "HTTP from ALB"
          },
          {
            "from_port": 22,
            "to_port": 22,
            "protocol": "tcp",
            "cidr_blocks": ["10.0.0.0/16"],
            "description": "SSH from VPC"
          }
        ],
        "egress": [
          {
            "from_port": 0,
            "to_port": 0,
            "protocol": "-1",
            "cidr_blocks": ["0.0.0.0/0"]
          }
        ],
        "tags": {
          "Name": "web-sg"
        }
      },
      "database": {
        "name": "database-security-group",
        "description": "Security group for RDS database",
        "vpc_id": "${aws_vpc.main.id}",
        "ingress": [
          {
            "from_port": 5432,
            "to_port": 5432,
            "protocol": "tcp",
            "security_groups": ["${aws_security_group.web.id}"],
            "description": "PostgreSQL from web tier"
          }
        ],
        "egress": [
          {
            "from_port": 0,
            "to_port": 0,
            "protocol": "-1",
            "cidr_blocks": ["0.0.0.0/0"]
          }
        ],
        "tags": {
          "Name": "database-sg"
        }
      }
    },
    "aws_lb": {
      "web": {
        "name": "web-alb",
        "internal": false,
        "load_balancer_type": "application",
        "security_groups": ["${aws_security_group.alb.id}"],
        "subnets": [
          "${aws_subnet.public_1.id}",
          "${aws_subnet.public_2.id}"
        ],
        "enable_deletion_protection": false,
        "tags": {
          "Name": "web-alb",
          "Environment": "production"
        }
      }
    },
    "aws_instance": {
      "web_1": {
        "ami": "ami-0c55b159cbfafe1f0",
        "instance_type": "t3.medium",
        "subnet_id": "${aws_subnet.private_app_1.id}",
        "vpc_security_group_ids": ["${aws_security_group.web.id}"],
        "tags": {
          "Name": "web-server-1",
          "Tier": "application",
          "Role": "web-server"
        }
      },
      "web_2": {
        "ami": "ami-0c55b159cbfafe1f0",
        "instance_type": "t3.medium",
        "subnet_id": "${aws_subnet.private_app_2.id}",
        "vpc_security_group_ids": ["${aws_security_group.web.id}"],
        "tags": {
          "Name": "web-server-2",
          "Tier": "application",
          "Role": "web-server"
        }
      }
    },
    "aws_db_subnet_group": {
      "main": {
        "name": "main-db-subnet-group",
        "subnet_ids": [
          "${aws_subnet.private_db_1.id}",
          "${aws_subnet.private_db_2.id}"
        ],
        "tags": {
          "Name": "main-db-subnet-group"
        }
      }
    },
    "aws_db_instance": {
      "main": {
        "identifier": "main-database",
        "engine": "postgres",
        "engine_version": "15.3",
        "instance_class": "db.t3.medium",
        "allocated_storage": 100,
        "storage_type": "gp3",
        "db_name": "appdb",
        "username": "dbadmin",
        "password": "changeme123!",
        "db_subnet_group_name": "${aws_db_subnet_group.main.name}",
        "vpc_security_group_ids": ["${aws_security_group.database.id}"],
        "multi_az": true,
        "backup_retention_period": 7,
        "skip_final_snapshot": true,
        "tags": {
          "Name": "main-database",
          "Environment": "production"
        }
      }
    }
  }
}
